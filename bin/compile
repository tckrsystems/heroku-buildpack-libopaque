#!/bin/bash

set -e
set -o pipefail

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
INSTALL_DIR="$BUILD_DIR/vendor/libopaque"

echo "-----> Fetching libopaque from GitHub"
LIBOPAQUE_REPO="https://github.com/stef/libopaque.git"
git clone $LIBOPAQUE_REPO $CACHE_DIR/libopaque

cd $CACHE_DIR/libopaque

echo "-----> Building libopaque"
git submodule update --init --recursive --remote
cd src
make

echo "-----> Installing libopaque"
mkdir -p $INSTALL_DIR/lib
mkdir -p $INSTALL_DIR/include
cp *.a $INSTALL_DIR/lib/
cp *.h $INSTALL_DIR/include/

echo "-----> Exporting environment variables"
cat << EOF > $BUILD_DIR/.profile.d/libopaque.sh
export LD_LIBRARY_PATH="$INSTALL_DIR/lib:\$LD_LIBRARY_PATH"
export LIBRARY_PATH="$INSTALL_DIR/lib:\$LIBRARY_PATH"
export CPATH="$INSTALL_DIR/include:\$CPATH"
EOF
